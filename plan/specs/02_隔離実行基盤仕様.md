# 隔離実行基盤仕様書 v0.2-draft

## 1. 目的

Issue 単位の隔離実行でホスト保護を実現し、実行失敗時も影響範囲を最小化する。

## 2. スコープ

- Docker `1 Issue / 1 Run` のライフサイクル
- リソース制限と権限制限
- ネットワーク制限
- 終了時クリーンアップ

## 3. 前提

- 実行環境は Apple Mac Studio（M3 Ultra / メモリ512GB）の self-hosted runner で Docker が利用可能。
- コンテナ実行は非 root を基本とする。
- ホストは指揮と成果物受領に限定し、直接編集は行わない。

## 4. 機能要件

### FR-201 コンテナ起動

- Run 開始時に専用コンテナを新規作成。
- 旧 Run のコンテナを再利用しない。

### FR-202 作業ディレクトリ

- リポジトリ取得はコンテナ内部で実施。
- ホストディレクトリの書き込みマウントは禁止。
- 例外的マウントは allowlist 明記時のみ許可。

### FR-203 権限/リソース

- 最低限の制限値を運用設定で必須化:
  - CPU 上限
  - メモリ上限
  - PIDs 上限
  - ディスク使用量上限
- 初期制限値は M3 Ultra / 512GB 前提で設計し、観測結果で見直す。

### FR-204 ネットワーク

- 既定は deny 寄り。
- allowlist 対象のみ通信許可:
  - GitHub
  - LiteLLM / LM Studio
  - 明示したパッケージレジストリ

### FR-205 クリーンアップ

- Run 正常終了/異常終了を問わずコンテナを破棄。
- 破棄失敗時は再試行後、`cleanup_failed` として監査記録。

## 5. 非機能要件

- 安全性: Run 間で FS とプロセス状態が共有されない。
- 可用性: コンテナ起動失敗時の再試行方針が定義される。

## 6. 入出力契約

### 入力

- `run_id`
- 実行対象リポジトリ情報
- ネットワーク/リソースポリシー

### 出力

- 実行ログ（要約）
- 成果物アーカイブ（パッチ、テスト結果、サマリ）

## 7. 異常系

- イメージ取得失敗: Run を `blocked` とし、依存環境異常として通知。
- OOM/CPU 制限超過: 実行中断し `resource_exceeded` として記録。
- クリーンアップ失敗: 運用アラートを発火。

## 8. 受け入れ条件

- 同一ホストで複数 Run 実行時に作業ファイルが相互参照されない。
- Run 終了後に対象コンテナが残存しない。
- allowlist 外向き通信が遮断される。

## 9. 未決事項

- ベースイメージの標準化方針（言語/フレームワーク別分割要否）。
- ディスク上限の初期値。
- ネットワーク制御の実現レイヤー（Docker ネットワーク設定か外部FWか）。
