# タスク分解とロール実行仕様書 v0.2-draft

## 1. 目的

Spec Block を機械処理可能なタスク群へ分解し、ロール切替で一貫実行する方式を定義する。

## 2. スコープ

- DAG 生成ルール
- タスク定義スキーマ
- ステージ順序
- Tool Scope 強制

## 3. 前提

- 開発者との対話窓口は PM Agent のみ。
- Orchestrator は Spec Block を唯一入力として扱う。
- v0.2 はマルチプロセスではなくロール切替方式を採用。

## 4. 機能要件

### FR-301 タスクDAG生成

- 入力 Spec から標準テンプレート（設計 -> 実装 -> 品質）を作成。
- Issue 内容に応じてタスク省略/追加を許可。
- 依存関係は DAG として循環を禁止。

### FR-302 タスク定義必須項目

各タスクは以下を必須とする。

- `task_id`
- `stage`
- `role`
- `deps`
- `model_label`
- `tool_scope`
- `inputs`
- `outputs`
- `retry_policy`
- `timeout_sec`

必須項目が欠けたタスクは実行不可。

### FR-303 ステージ順序

- 設計完了前に実装を開始しない。
- 実装完了前に品質ステージを開始しない。
- `ops` ステージは例外ラベル時のみ開始可能。

### FR-304 ロール切替

- Runner はタスク開始時に以下を切替える:
  - Role Prompt
  - Model Label
  - Tool Scope
  - 作業コンテキスト

### FR-305 成果物契約

- `outputs` は後続参照可能な命名規約に従う。
- 実ファイルが存在しない場合はタスク失敗とする。

## 5. 非機能要件

- 再現性: 同一 Spec で同一テンプレートを生成できる。
- 保守性: ロール定義追加時に既存 DAG ルールを壊さない。

## 6. 入出力契約

### 入力

- Issue Spec Block
- リポジトリスキャン結果（任意）

### 出力

- Task DAG（JSON/YAML）
- Task Log（Issue コメント）

## 7. 異常系

- DAG 循環検出: Run を即時 `blocked`。
- タイムアウト超過: タスク単位でリトライし、上限超過で `blocked`。
- Tool Scope 逸脱操作: 実行拒否しセキュリティイベント記録。

## 8. 受け入れ条件

- 全タスクに `model_label` と `tool_scope` が設定される。
- ステージ逆転（品質先行など）が発生しない。
- 各タスク終了時に構造化 Task Log が残る。

## 9. 未決事項

- DAG 生成アルゴリズムの詳細（ルールベース固定か将来学習型か）。
- `ui_ux` などドキュメント中心タスクの完了判定基準。
- ロール間で共有する最小コンテキスト量。
