# AI監査ジョブ実装詳細仕様書 v0.2-draft

## 1. 目的

`22_AI監査自動化運用仕様.md` を次フェーズでコード実装に移せるよう、ジョブ構成・入出力・判定契約を詳細化する。

## 2. 前提

- 本書は実装準備のための仕様であり、企画フェーズ内ではコード作成を行わない。
- 認証主体は GitHub App（bot）を標準とする。
- `run_control` は `continue/blocked` の2値で管理する。

## 3. 実装対象（次フェーズ）

- GitHub APIから監査対象設定を取得するジョブ
- 取得結果に判定ルールを適用する評価器
- 監査結果をテンプレートへ反映するレポート生成器
- `blocked` 検知時の通知と台帳更新補助

## 4. コンポーネント設計

### 4.1 Collector（設定収集）

- 入力:
  - リポジトリ名
  - 対象ブランチ（既定: `main`）
  - GitHub App installation token
- 出力:
  - Branch protection実測値
  - required checks実測値
  - Repository設定実測値
- 失敗時:
  - `collector_failed` を返却し、評価段階へ進まない

### 4.2 Evaluator（判定適用）

- 入力:
  - Collector出力
  - 期待値定義（`specs/20`/`specs/22`）
  - 監査メタデータ（`run_id`/`app_slug`）
- 出力:
  - 監査判定（`pass/blocked`）
  - `run_control`（`continue/blocked`）
  - 差分一覧（項目/期待値/実測/理由）
- 判定優先順位:
  - 1) 監査メタデータ欠落
  - 2) Branch protection差分
  - 3) required checks差分
  - 4) Repository設定差分
  - 5) 差分なし

### 4.3 Reporter（レポート生成）

- 入力:
  - Evaluator出力
  - `plan/templates/GitHubブランチ保護自動監査結果テンプレート.md`
- 出力:
  - `plan/GitHubブランチ保護監査_YYYY-MM-DD.md`（追記または新規）
  - Issueコメント用要約（短文）

### 4.4 Dispatcher（通知・台帳補助）

- 入力:
  - Evaluator出力
  - 監査実行コンテキスト（定期/臨時/再実行）
- 出力:
  - `blocked` 時の通知文案
  - `plan/バックログ.md` 追加候補
  - `plan/リスク登録簿.md` 更新候補

## 5. データ契約

### 5.1 監査実行入力（概念）

- `audit_id`
- `run_id`
- `app_slug`
- `repo`
- `branch`
- `mode`（`scheduled/manual/retry`）

### 5.2 監査判定出力（概念）

- `audit_id`
- `result`（`pass/blocked`）
- `run_control`（`continue/blocked`）
- `diffs[]`（`field`, `expected`, `actual`, `reason`）
- `failed_stage`（失敗時のみ）

## 6. エラーハンドリング

- API認証失敗:
  - 1回再試行し、継続失敗時は `blocked`
- APIレート制限:
  - backoff後に1回再試行し、継続失敗時は `blocked`
- テンプレート埋め込み失敗:
  - レポート生成を中断し `blocked`
- 判定不能:
  - fail-closedで `blocked`

## 7. 運用シナリオ

### 7.1 定期監査（毎週金曜）

- Collector -> Evaluator -> Reporter -> Dispatcher の順で実行する。
- 差分なしの場合はレポート保存のみ実施する。

### 7.2 臨時監査（設定変更日）

- 設定変更イベントをトリガに同日中に実行する。
- 差分ありの場合は是正タスク案を必ず生成する。

### 7.3 再実行（失敗時）

- 当日中に1回以上再実行する。
- 2回連続失敗時は `R-029` の監視指標を更新対象にする。

## 8. 受け入れ条件（次フェーズ）

- `specs/22` の判定表どおりに `pass/blocked` が再現される。
- 監査結果に `run_id` / `app_slug` が欠落しない。
- `blocked` 時に是正タスク案を生成できる。
- レポートがテンプレート項目を欠落なく埋める。

## 9. 依存仕様

- `plan/specs/20_GitHub前提コミットPRマージ完了運用仕様.md`
- `plan/specs/22_AI監査自動化運用仕様.md`
- `plan/specs/14_GitHub App認証と鍵管理仕様.md`
- `plan/specs/11_policy例外ラベル運用規程.md`
- `plan/specs/24_開発環境構築仕様.md`

## 10. 未決事項

- なし（Collector/Evaluator/Reporter/Dispatcher の実装方式は確定）
