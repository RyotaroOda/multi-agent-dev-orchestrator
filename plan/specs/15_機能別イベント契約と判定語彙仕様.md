# 機能別イベント契約と判定語彙仕様書 v0.2-draft

## 1. 目的

`13_機能別開発者実装準備仕様.md` を起点に、各機能の入出力イベント契約と判定語彙を実装前に揃える。

## 2. スコープ

- Run/Task の共通イベントキー
- 機能別の必須入出力（成功系/異常系）
- 判定語彙の固定（状態/品質/ポリシー）
- `blocked_reason` の分類方針

## 3. 前提

- 企画フェーズでは実装コードを作成しない。
- `run_id` は全イベントの共通キーとする。
- 判定体制は `AIプランナーエージェント（評価支援） + ユーザー（最終判定）` とする。
- セキュリティ優先順位 `A:漏えい防止 > B:ホスト保護 > C:課金回避` を維持する。

## 4. 共通イベント契約

### 4.1 Runイベント共通キー

- 必須キー:
  - `run_id`
  - `stage`
  - `timestamp`
  - `result`
  - `next_action`
- 条件付きキー:
  - `blocked_reason`（`result=blocked` の場合）
  - `model_label` / `resolved_model`（モデル利用時）
  - `app_slug`（PR作成イベント時）

### 4.2 判定語彙（v0.2固定）

- 実行状態:
  - `queued` / `running` / `retry` / `blocked` / `completed`
- ポリシー評価:
  - `allow` / `deny`
- 品質ゲート:
  - `pass` / `blocked`
- M4判定:
  - `Go` / `Conditional Go` / `No-Go`

### 4.3 追跡チェーン

- 最低追跡経路:
  1. Runイベント（`run_id`）
  2. 成果物検証（`run_id` + ハッシュ）
  3. PR本文（`run_id` + `app_slug`）
  4. KPI集計（`run_id` 起点）

## 5. 機能別イベント契約（13ベース）

| 機能ID | 必須入力 | 成功時必須出力 | 異常時必須出力 | 根拠仕様 |
| --- | --- | --- | --- | --- |
| F-1301 | Issueラベルイベント、`/retry` コメント | Run Header、状態ラベル更新、新 `run_id` | `agent:blocked` への遷移、失敗要約、`blocked_reason` | `01_Issue駆動実行管理仕様.md` |
| F-1302 | `run_id`、リポジトリ情報、制限ポリシー | 実行ログ要約、成果物アーカイブ | `resource_exceeded` / `cleanup_failed` 記録、アラート | `02_隔離実行基盤仕様.md` |
| F-1303 | 目的、受け入れ条件、制約 | DAG、ロール別実行計画、成果物契約 | 分解不能時の `blocked` と判断依頼 | `03_タスク分解とロール実行仕様.md` |
| F-1304 | タスク種別、負荷指標 | 解決モデル、制御レベル、遷移理由 | fallback後失敗時の `blocked`、`fallback_used=true` | `04_モデルルーティングとリソース制御仕様.md` |
| F-1305 | 実行イベント、例外申請データ（4項目） | `allow/deny`、拒否理由コード | 判定不能時 fail-closed + `agent:blocked` | `05_セキュリティポリシー運用仕様.md` |
| F-1306 | CI結果、差分情報、例外ラベル情報 | `pass/blocked`、根拠付き判定結果 | ルールエンジン失敗時 `blocked`、理由出力 | `06_品質ゲートと自動マージ仕様.md` |
| F-1307 | コンテナ成果物、`run_id`、App認証情報 | 検証済み差分、PR情報、`app_slug` | ハッシュ不一致/PR API失敗/token異常を `blocked` 記録 | `07_成果物受け渡しとPR作成仕様.md`, `14_GitHub App認証と鍵管理仕様.md` |
| F-1308 | Run/Taskイベント、CI結果、計測値 | 構造化ログ、KPI集計、アラート | `observability_degraded` / `missing_data` | `08_可観測性とKPI運用仕様.md` |
| F-1309 | M4チェックリスト、バックログ、リスク、ADR | 判定結果、判定理由、不足項目 | 根拠欠損時 `Conditional Go候補` として記録 | `12_M4本判定と開発着手条件仕様.md` |
| F-1310 | DGX差分要件、Mac基準制限値/KPI | 移行判断材料、差分制限値案 | v0.2必須スコープ混入時は保留判断 | `09_DGX Spark対応方針.md` |
| F-1311 | App ID、Installation ID、安全ストア鍵参照、`run_id` | installation token、PR作成結果、監査ログ | token発行失敗/権限不足を `blocked` 記録 | `14_GitHub App認証と鍵管理仕様.md` |

## 6. `blocked_reason` 分類方針

- v0.2で使用または明示済みの主要分類:
  - `spec_invalid`
  - `lock_mismatch`
  - `resource_exceeded`
  - `cleanup_failed`
  - `retry_condition_unmet`
  - `policy_denied`
  - `quality_rule_violation`
  - `hash_mismatch`
  - `pr_api_error`
  - `token_issue`
- 運用ルール:
  - 1 Run に主要因を1つ記録する。
  - 複合要因は `secondary_reasons` に補助記録する。
  - KPI集計は主要因の `blocked_reason` で算出する。

## 7. 実装前チェック（ドキュメント）

- チェック1: 各機能の必須入力がテンプレート/運用手順で埋められる。
- チェック2: 異常時出力に「人間の次判断」が含まれる。
- チェック3: `run_id` から PR/KPI まで追跡できる。
- チェック4: 例外4項目（理由/適用範囲/失効日/承認者）が全機能で矛盾しない。

## 8. 固定値（v0.2確定）

- `blocked_reason` 命名規約: `snake_case` 固定（接頭辞なし）
- `timestamp` 形式: UTC固定のISO8601（例: `2026-02-10T15:04:05Z`）
- Run Header 記録形式: JSON固定
