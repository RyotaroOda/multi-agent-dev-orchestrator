# DEV-001 状態遷移と復帰契約仕様 v0.2-draft

## 1. 目的

Issue `#5`（DEV-001）で扱う実行状態遷移と復帰判定を具体化し、`run_id` と `blocked_reason` の運用解釈を一意にする。

## 2. スコープ

- 対象Issue: `#5`
- 対象機能: `F-1301`（Issue受付と実行状態管理）、`F-1303`（タスク分解とロール実行）
- 対象状態: `queued` / `running` / `retry` / `blocked` / `completed`
- 対象外: 実装方式、ライブラリ選定、UI詳細

## 3. 前提

- 現在フェーズは企画であり、実装コード作成・依存追加・ビルド/テスト実行は行わない。
- 一次参照は `13 -> 15 -> 16 -> 17` を維持し、本仕様は DEV-001 の補助詳細とする。
- セキュリティ優先順位 `A:漏えい防止 > B:ホスト保護 > C:課金回避` を維持する。

## 4. 契約用語

- `状態`: `queued` / `running` / `retry` / `blocked` / `completed`
- `retry`: `agent:retry` ラベルの受付中状態
- `復帰要求`: `agent:retry` ラベルまたは `/retry` コメント
- `run_id`: Run単位の一意キー。復帰時は必ず再採番する。

## 5. 許可状態遷移

| 遷移ID | 現在 | 次状態 | ガード条件 | 監査必須記録 | 不成立時 |
| --- | --- | --- | --- | --- | --- |
| TR-1801 | `queued` | `running` | Spec Block妥当、同一Issueに有効 `run_id` がない、排他取得成功 | `run_id`, `transition_at`, `trigger`, `actor` | `blocked` へ遷移し `blocked_reason=spec_invalid` または `lock_mismatch` |
| TR-1802 | `running` | `completed` | 必須処理完了、fail-closed条件なし | `run_id`, `result_summary`, `transition_at` | `blocked` へ遷移 |
| TR-1803 | `running` | `blocked` | 失敗/例外/停止条件を検知 | `run_id`, `blocked_reason`, `failure_point`, `next_human_action` | なし（必ず `blocked` 記録） |
| TR-1804 | `blocked` | `retry` | 復帰要求が権限内、復帰可否の人間判断コメントあり、give-up上限未超過 | `previous_run_id`, `retry_reason`, `requested_by`, `requested_at` | `blocked` 維持 + `blocked_reason=retry_condition_unmet` |
| TR-1805 | `retry` | `running` | 新 `run_id` 採番成功、Run Header記録成功 | `previous_run_id`, `new_run_id`, `transition_at`, `actor` | `blocked` へ遷移し `blocked_reason=retry_condition_unmet` |

補足:
- `TR-1805` で `running` に遷移する際、旧 `run_id` は失効扱いとする。
- 上記以外の遷移は v0.2 で不許可とする。

## 6. 不許可遷移

- `blocked -> queued`
- `completed -> running`
- `completed -> queued`
- `blocked -> running`（`retry` を経由しない直接復帰）
- `queued -> completed`

## 7. 状態遷移チェック観点一覧（企画→実装引き渡し）

| 観点ID | 確認観点 | 合格条件 |
| --- | --- | --- |
| CK-1801 | 二重起動防止 | 同一Issueで有効 `run_id` が同時に2つ存在しない |
| CK-1802 | 排他整合 | `run_id` 不一致更新が拒否され、`lock_mismatch` が記録される |
| CK-1803 | 復帰状態整合 | 復帰時は `blocked -> retry -> running` の順で遷移する |
| CK-1804 | 復帰再採番 | `retry -> running` 遷移時に必ず新 `run_id` が発行される |
| CK-1805 | 復帰前提検証 | 人間判断コメント欠落時は `retry_condition_unmet` を記録して復帰拒否する |
| CK-1806 | 語彙整合 | `blocked_reason` が本仕様と `15` の定義語彙のみで構成される |
| CK-1807 | give-up整合 | give-up上限は `01` の `FR-105`（初期値5）と一致する |

## 8. blocked復帰判定の入力項目一覧（企画→実装引き渡し）

| 入力ID | 項目 | 必須 | 説明 |
| --- | --- | --- | --- |
| IN-1801 | `issue_id` | 必須 | 復帰対象Issue |
| IN-1802 | `previous_run_id` | 必須 | 直前の `blocked` Run識別子 |
| IN-1803 | `blocked_reason` | 必須 | 主要因（1件） |
| IN-1804 | `failure_summary` | 必須 | 直近失敗点の要約 |
| IN-1805 | `human_decision_comment` | 必須 | 人間判断のIssueコメント参照 |
| IN-1806 | `retry_reason` | 必須 | 再実行する理由 |
| IN-1807 | `requested_by` | 必須 | 復帰要求者（権限確認対象） |
| IN-1808 | `requested_at` | 必須 | 復帰要求時刻 |
| IN-1809 | `authorization_result` | 必須 | 権限判定結果（許可/拒否） |
| IN-1810 | `give_up_count` | 必須 | 既存のretry回数 |
| IN-1811 | `max_retry` | 必須 | 上限回数（初期値5） |

## 9. DEV-001で使用する `blocked_reason`

- `spec_invalid`
- `lock_mismatch`
- `resource_exceeded`
- `cleanup_failed`
- `retry_condition_unmet`

運用ルール:
- 1 Run の主要因は1件のみ記録する。
- 複合要因は `secondary_reasons` に補助記録する。
- 未定義語彙は使用しない。

## 10. 未決事項

- なし（DEV-001着手に必要な状態遷移契約と復帰入力項目は確定）。

## 11. Issue #5レビュー参照

- 状態遷移の正本: `01_Issue駆動実行管理仕様.md` の「7. 状態遷移」
- give-up上限の正本: `01_Issue駆動実行管理仕様.md` の `FR-105`（初期値5）
- 語彙の正本: `15_機能別イベント契約と判定語彙仕様.md`
