# DEV-001 状態遷移と復帰契約仕様 v0.2-draft

## 1. 目的

Issue `#5`（DEV-001）で扱う実行状態遷移と復帰判定を、`13`/`15`/`16`/`17` を起点に詳細化し、着手時の解釈差分を抑止する。

## 2. スコープ

- 対象機能: `F-1301`（Issue受付と実行状態管理）、`F-1303`（タスク分解とロール実行）
- 対象Issue: `#5`
- 対象状態: `queued`, `running`, `blocked`, `completed`
- 対象外: 実装方式、ライブラリ選定、運用UI詳細

## 3. 前提

- 現在フェーズは企画であり、実装コード作成・依存追加・ビルド/テスト実行は行わない。
- 標準実行環境は Apple Mac Studio M3 Ultra（メモリ512GB）とする。
- 判定体制は `AIプランナーエージェント + ユーザー` の2者運用とする。
- セキュリティ優先順位 `A:漏えい防止 > B:ホスト保護 > C:課金回避` を維持する。

## 4. 入力契約

| 入力ID | 入力名 | 必須項目 | 受理条件 | 不受理時 |
| --- | --- | --- | --- | --- |
| IN-1801 | 実行開始要求 | `issue_id`, `requested_by`, `requested_at` | Spec Block妥当、対象Issueが実行可能状態 | `blocked` + `blocked_reason=spec_invalid` |
| IN-1802 | 実行更新要求 | `run_id`, `from_state`, `to_state`, `updated_at` | 現在の `run_id` と一致し、遷移表に合致 | 更新拒否 + `blocked_reason=lock_mismatch` |
| IN-1803 | retry要求 | `issue_id`, `previous_run_id`, `requested_by`, `reason` | `blocked` 状態で、復帰要件を満たす | `blocked` 維持 + `blocked_reason=retry_condition_unmet` |

## 5. 状態遷移契約

| 現在 | 次状態 | 条件 | 監査必須記録 |
| --- | --- | --- | --- |
| `queued` | `running` | `run_id` 採番済み、排他ロック取得済み | `run_id`, `transition_at`, `actor` |
| `running` | `completed` | 成果物処理と最終判定が成功 | `run_id`, `result_summary`, `transition_at` |
| `running` | `blocked` | 失敗時または fail-closed 条件検出 | `run_id`, `blocked_reason`, `transition_at` |
| `blocked` | `queued` | retry許可、再実行受付完了 | `previous_run_id`, `new_run_id`, `retry_reason` |

補足:
- `blocked -> queued` へ復帰する際は、新しい `run_id` を必須発行する。
- `queued/running/blocked/completed` 以外の状態は v0.2 では扱わない。

## 6. `blocked_reason` 最小分類

| 分類 | 説明 | 優先度 |
| --- | --- | --- |
| `spec_invalid` | Spec Block不足・不正形式 | P0 |
| `lock_mismatch` | `run_id` 不一致または排他破綻 | P0 |
| `policy_denied` | ポリシー評価で deny | P0 |
| `resource_exceeded` | 制限値超過で継続不可 | P1 |
| `retry_condition_unmet` | 復帰前提不足でretry不可 | P1 |

補足:
- 命名規約は `snake_case` 固定とする。
- 未定義語彙を使用する場合は、事前に `15_機能別イベント契約と判定語彙仕様.md` を更新する。

## 7. 復帰判定契約（retry）

1. 直前状態が `blocked` であること
2. `blocked_reason` が記録済みであること
3. 復帰可否の人間判断コメントが残っていること
4. 新しい `run_id` を発行できること

上記を1つでも満たさない場合、`blocked` を維持し `retry_condition_unmet` を記録する。

## 8. 受け入れ観点（企画）

- 同一入力に対し、許可遷移が一意に読める。
- `run_id` 再発行の要否が曖昧でない。
- `blocked_reason` が未定義語彙なしで運用できる。
- `17_初回開発着手ハンドオーバー仕様.md` の DEV-001 条件と矛盾しない。

## 9. 未決事項

- なし（v0.2の初回着手範囲で確定済み）。
