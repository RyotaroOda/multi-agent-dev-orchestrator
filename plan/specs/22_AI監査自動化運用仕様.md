# AI監査自動化運用仕様書 v0.2-draft

## 1. 目的

GitHubブランチ保護監査と運用整合監査をAIで自動化し、監査の継続性と再現性を高める。

## 2. 前提

- 現在フェーズは企画であり、実装コード作成・依存追加・ビルド/テスト実行は行わない。
- セキュリティ優先順位 `A:漏えい防止 > B:ホスト保護 > C:課金回避` を崩さない。
- 最終責任は Integrator（人間）が持ち、AIは監査実行者として扱う。
- SoTは GitHub設定値、Issue/PR、CIログ、`plan` 台帳とする。

## 3. スコープ

### 3.1 自動監査の対象

- Branch protection設定
- required checks設定
- Repository設定（Squash / head branch自動削除）
- `run_id` / `app_slug` / 例外ラベル4項目の記録欠落
- 判定語彙（`allow/deny/blocked`）整合

### 3.2 人間承認が必要な対象

- 例外許可の妥当性判断
- リスク受容（`accepted`）の判断
- 監査で検知した差分の優先順位最終決定

## 4. 役割

| 役割 | 主責務 |
| --- | --- |
| Audit Agent（AI） | 監査実行、差分抽出、レポート草案、台帳更新案の作成 |
| Integrator（人間） | 差分是正の最終判断、例外承認、リスク受容判断 |
| Reviewer Agent（AI） | 監査結果の語彙整合・記録整合のクロスチェック |

## 5. 実行トリガ

- 定期監査: 週1回（毎週金曜）
- 臨時監査: Branch protection / required checks / Merge設定を変更した同日中
- 失敗再実行: 監査ジョブ失敗時は同日中に1回以上再実行

## 6. 入出力契約

### 6.1 入力

- GitHub設定の実測値（対象ブランチ `main`）
- required checks一覧
- 最新週の監査対象PRとIssue
- 直近の `plan/バックログ.md` / `plan/リスク登録簿.md` / `plan/意思決定ログ.md`

### 6.2 出力

- 監査レポート（`plan/GitHubブランチ保護監査_YYYY-MM-DD.md`）
- 実施記録（Issueコメント）
- 構造化監査ログ（`run_id`, `app_slug`, 判定結果）
- 差分あり時の台帳更新案（バックログ/リスク/ADR）

## 7. 判定ルール（v0.2固定）

| 条件 | 監査判定 | `run_control` | 必須アクション |
| --- | --- | --- | --- |
| 必須設定がすべて一致 | `pass` | `continue` | レポート保存のみ |
| 必須設定に差分あり | `blocked` | `blocked` | 是正タスクを `plan/バックログ.md` へ追加 |
| `run_id` / `app_slug` / 例外4項目の欠落 | `blocked` | `blocked` | 欠落補完まで新規 `queued` を停止 |
| 監査ジョブ失敗（データ取得失敗等） | `blocked` | `blocked` | 同日再実行 + 失敗理由を記録 |

補足:
- fail-closedを原則とし、判定不能時は `blocked` を返す。
- AIの判定結果は Integrator が最終確認するまで確定扱いにしない。

## 8. 記録フォーマット

- テンプレートは `plan/templates/GitHubブランチ保護自動監査結果テンプレート.md` を使用する。
- 監査IDは `AUDIT-YYYYMMDD-<連番>` 形式で採番する。
- 監査実行単位で `run_id` を必須記録する。

## 9. 異常時運用

- 2回連続で監査失敗した場合:
  - `plan/リスク登録簿.md` に監査停止リスクを `watching` で記録する。
  - Integrator は24時間以内に実行経路の復旧方針を決定する。
- 自動監査結果と人間確認が矛盾した場合:
  - 人間確認結果を優先し、差分原因を `plan/意思決定ログ.md` に残す。

## 10. 台帳反映ルール

- 企画判断の追加/更新: `plan/意思決定ログ.md`
- 是正タスクの追加/更新: `plan/バックログ.md`
- 監査起因リスクの追加/更新: `plan/リスク登録簿.md`

## 11. 次フェーズ実装対象（コード）

- GitHub APIから監査項目を取得するジョブの実装
- 判定ルールを適用する評価スクリプトの実装
- レポート自動出力（テンプレート埋め込み）の実装
- `blocked` 検知時の通知・台帳更新補助の実装
- 実装詳細は `plan/specs/23_AI監査ジョブ実装詳細仕様.md` を正本として参照する

## 12. 未決事項

- なし（v0.2の運用境界として確定）。
