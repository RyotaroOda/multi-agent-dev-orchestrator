# 可観測性とKPI運用仕様書 v0.2-draft

## 1. 目的

各 Run の状況を追跡可能にし、v0.2 の成功可否を KPI で判定できるようにする。

## 2. スコープ

- Run/Task の構造化ログ
- KPI 定義
- 集計頻度とアラート
- ログ保持方針

## 3. 前提

- Issue コメントに構造化ログを投稿できる。
- LiteLLM からトークン数/レイテンシを取得できる。
- `run_id` を全イベントの共通キーとする。

## 4. 機能要件

### FR-801 Runログ

- 各ステージ終了時に以下を記録:
  - `run_id`
  - `stage`
  - `model_label` / `resolved_model`
  - 主要コマンド結果
  - 次アクション

### FR-802 Taskログ

- 各タスク終了時に `task_id`, `role`, `result`, `artifacts` を記録。

### FR-803 KPI算出

- v0.2 最低 KPI:
  - 24時間あたり処理 Issue 数
  - PR 作成率
  - マージ率
  - blocked 率（理由カテゴリ別）
  - `resource_exceeded` を理由とする blocked 率
  - 平均 Run 時間（ステージ別）
  - リトライ回数分布
- 運用補助指標:
  - メモリプレッシャ警告回数（24時間）

### FR-804 可視化/通知

- 集計結果を定期出力（例: 日次サマリ）。
- しきい値逸脱時に運用アラートを発火。

### FR-806 KPI目標値とアラート閾値（v0.2確定）

- KPI目標値（M3 Ultra / 512GB 前提）:
  - 24時間あたり処理 Issue 数: `>= 6`
  - PR 作成率: `>= 70%`
  - マージ率: `>= 55%`
  - blocked 率（全体）: `<= 25%`
  - `resource_exceeded` blocked 率: `<= 5%`
  - 平均 Run 時間（全ステージ合算）: `p50 <= 90分` かつ `p90 <= 180分`
  - リトライ回数分布: `p95 <= 2回`
- アラート閾値:
  - throughput `< 4` が2日連続
  - マージ率 `< 40%` が2日連続
  - blocked率 `> 35%` が24時間継続
  - `resource_exceeded` blocked率 `> 8%` が24時間継続
  - Run時間 `p50 > 120分` または `p90 > 240分` が24時間継続

### FR-805 保持方針

- 機密を含まない要約ログを保持。
- 高詳細ログは必要時のみ短期保持。

### FR-807 ログ保持期間と保存先（v0.2確定）

- 保存先:
  - SoTログ（Run/Task構造化ログ）: GitHub Issue コメント
  - KPI日次集計: runner 内部の運用ストア（Issueとは分離）
  - 高詳細デバッグログ: runner ローカル一時領域（暗号化前提）
- 保持期間:
  - SoTログ: 企画・運用履歴として保持（削除しない）
  - KPI日次集計: 365日
  - 高詳細デバッグログ: 14日
- 監査時:
  - 監査要求があるRunのみ、高詳細ログ保持を最長90日まで延長可能
  - 延長時は理由と期限を監査記録へ残す

## 5. 非機能要件

- 追跡性: 1 Run の開始から PR まで一意追跡可能。
- 低漏えい: ログに秘密情報を残さない。

## 6. 入出力契約

### 入力

- Run/Task イベント
- CI 結果
- LiteLLM 計測値

### 出力

- 構造化ログ（Issue コメント）
- KPI 集計レポート

## 7. 異常系

- ログ書き込み失敗: 再試行し、継続失敗で `observability_degraded` を記録。
- 指標欠損: 集計に `missing_data` フラグを付与。
- 時刻不整合: 同期異常として運用通知。

## 8. 受け入れ条件

- 任意の PR から `run_id` 経由で Run ログへ遡及できる。
- KPI が日次で算出される。
- 秘密情報がログに含まれない。

## 9. 未決事項

- なし（v0.2範囲で確定済み）。
