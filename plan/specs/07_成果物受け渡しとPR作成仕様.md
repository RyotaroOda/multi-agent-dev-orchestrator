# 成果物受け渡しとPR作成仕様書 v0.2-draft

## 1. 目的

方式A（コンテナ非 push）で、漏えいリスクを抑えつつ成果物を安全に PR 化する。

## 2. スコープ

- コンテナ出力物の定義
- ホスト側取り込み手順
- 整合性検証
- PR 作成/更新

## 3. 前提

- コンテナ内に GitHub 書き込みトークンを配置しない。
- ホスト側がブランチ作成、コミット、PR 作成を担当。
- Run 単位で成果物は `run_id` と紐付く。
- GitHub への書き込み主体は GitHub App（installation token）を標準とする。
- 人アカウントの PAT は非常時を除き PR 自動作成経路で使用しない。

## 4. 機能要件

### FR-701 コンテナ出力

- 必須成果物:
  - パッチ（`git diff` または patch ファイル）
  - テスト/静的解析結果
  - ステージ要約

### FR-702 受領検証

- 受領時に以下を検証:
  - `run_id` 一致
  - 生成時刻妥当性
  - ハッシュ整合
- ハッシュ方式は `SHA-256` を固定採用する。

### FR-703 取り込み

- クリーンな作業ブランチを作成しパッチ適用。
- 適用失敗時は自動修復せず `blocked`。

### FR-704 PR 作成

- PR 本文へ以下を含める:
  - 対象 Issue
  - `run_id`
  - 主要結果（テスト、ルール検査）
  - 既知の制約

### FR-705 更新/再実行

- `retry` Run は原則新規 PR を作成。
- 旧 PR の扱い（close/comment）は運用ポリシーに従う。
- v0.2 の運用ポリシー:
  - 旧PRは `closed` とし、close理由と新PR URL をコメントで相互参照する
  - 同一Issueで同時に `open` を許可する自動生成PRは1件まで

### FR-706 署名検証方針（v0.2）

- v0.2では署名検証を必須化しない（ハッシュ検証を必須化）。
- 署名検証は v0.3 以降の拡張項目として扱う。

### FR-707 GitHub AppによるPR作成主体の固定

- PR/コミット作成主体は GitHub App の bot アカウントに固定する。
- ホストは都度 installation token を払い出して使用し、長期固定トークンを保存しない。
- App権限は最小化する（`contents:write`、`pull_requests:write`、`issues:write` を基準）。
- 自動PR本文に `run_id` と `app_slug` を記録し、監査時に追跡可能とする。

### FR-708 レビュー主体分離ルール

- PR author（GitHub App）と Approver（人間レビュアー）を分離する。
- 人間が手動で作成したPRは、同一人による approve を許可しない運用を継続する。
- 例外マージ（admin override）は `policy` 例外運用に従い、理由を Issue と PR に記録する。

## 5. 非機能要件

- 完全性: 不一致成果物を取り込まない。
- 監査性: どの Run がどの PR を生成したか追跡できる。

## 6. 入出力契約

### 入力

- コンテナ成果物アーカイブ
- 対象 Issue 情報

### 出力

- コミット
- PR URL
- 取り込みログ

## 7. 異常系

- ハッシュ不一致: 即時棄却し `blocked`。
- パッチ適用競合: `blocked` として人間介入待ち。
- PR API 失敗: 再試行後、失敗継続で `blocked`。
- App installation token 払い出し失敗/期限切れ: `blocked` とし、再払い出し後に1回だけ再試行する。

## 8. 受け入れ条件

- コンテナから GitHub への直接 push が行われない。
- `run_id` 不一致成果物が取り込まれない。
- PR から元 Run へ追跡できる。
- 自動作成PRの author が GitHub App bot であることを確認できる。

## 9. 未決事項

- なし（v0.2範囲で確定済み）。
