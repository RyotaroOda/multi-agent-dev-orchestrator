# 品質ゲートと自動マージ仕様書 v0.2-draft

## 1. 目的

LLM 判定に依存せず、必須 CI と差分ルールにより自動マージの安全性を担保する。

## 2. スコープ

- CI 必須チェック
- 差分ルール検査（ハック検知）
- 例外ラベルの適用条件
- Lv2 自動マージ条件

## 3. 前提

- 最終判定は GitHub 必須ステータスチェック。
- 品質エージェントは改善実行者であり、判定者ではない。

## 4. 機能要件

### FR-601 必須チェック

- 事前定義したチェックがすべて success の場合のみマージ可能。
- `pending` / `neutral` / `skipped` は合格扱いにしない。

### FR-602 差分ルール検査対象

- テスト削除・大規模コメントアウト・アサーション大幅減少
- `skip` / `only` 系の増加
- CI 設定改変（`.github/workflows/*`）
- テスト実行コマンド改変（例: `package.json scripts`）

### FR-603 ルール違反時

- 自動で `agent:blocked` に遷移。
- 違反種別と検知根拠を Issue コメントへ出力。

### FR-604 例外ラベル

- `policy:allow-test-change`
- `policy:allow-ci-change`

例外時でも理由・範囲・期限が必須。

### FR-605 自動マージ

- 必須チェック合格 + ルール違反なし + 排他整合ありで自動マージ。
- 競合発生時は自動解消せず `blocked`。

## 5. 非機能要件

- 説明可能性: すべての `blocked` は機械判定根拠を残す。
- 誤検知管理: 例外適用の履歴が監査できる。

## 6. 入出力契約

### 入力

- PR 差分
- CI ステータス
- 例外ラベル情報

### 出力

- `pass` / `blocked`
- 検知詳細（ルールID、対象ファイル、理由）

## 7. 異常系

- CI API 取得失敗: 判定停止（fail-safe）。
- ルールエンジン失敗: マージ禁止で `blocked`。
- 必須チェック一覧未設定: 自動マージ機能を無効化。

## 8. 受け入れ条件

- テスト削除や `skip/only` 混入が機械判定で検知される。
- 例外ラベル未設定時に CI/テスト改変が自動で止まる。
- 必須チェック未通過 PR はマージされない。

## 9. 未決事項

- v0.2 の必須チェック一覧（具体名）。
- アサーション減少の閾値（比率/件数）。
- 例外適用時の追認フロー（事後レビュー要否）。
