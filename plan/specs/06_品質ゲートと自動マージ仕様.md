# 品質ゲートと自動マージ仕様書 v0.2-draft

## 1. 目的

LLM 判定に依存せず、必須 CI と差分ルールにより自動マージの安全性を担保する。

## 2. スコープ

- CI 必須チェック
- 差分ルール検査（ハック検知）
- 例外ラベルの適用条件
- Lv2 自動マージ条件

## 3. 前提

- 最終判定は GitHub 必須ステータスチェック。
- 品質エージェントは改善実行者であり、判定者ではない。

## 4. 機能要件

### FR-601 必須チェック

- 事前定義したチェックがすべて success の場合のみマージ可能。
- `pending` / `neutral` / `skipped` は合格扱いにしない。
- v0.2 必須チェック名（固定）:
  - `required:test`
  - `required:lint`
  - `required:typecheck`
  - `required:policy-diff`
- 必須チェックのいずれかが未設定の場合、自動マージ機能は fail-safe で無効化する。

### FR-602 差分ルール検査対象

- テスト削除・大規模コメントアウト・アサーション大幅減少
- `skip` / `only` 系の増加
- CI 設定改変（`.github/workflows/*`）
- テスト実行コマンド改変（例: `package.json scripts`）
- 検知閾値（v0.2確定）:
  - `it.only` / `describe.only` / 同等記法の追加: 1件でも検知で blocked
  - `skip` 系記法の追加: 1件でも検知で blocked（例外不可）
  - アサーション減少: 変更対象テストファイル群で `30%超` または `20件以上` 減少で blocked（例外不可）
  - テストファイル削除: 1ファイル以上で blocked（例外不可）

### FR-603 ルール違反時

- 自動で `agent:blocked` に遷移。
- 違反種別と検知根拠を Issue コメントへ出力。

### FR-604 例外ラベル

- `policy:allow-test-change`
- `policy:allow-ci-change`

- 承認者要件:
  - `policy:allow-test-change` / `policy:allow-ci-change` は PM承認を必須とする。
  - 緊急適用時は24時間以内にセキュリティ担当の事後追認コメントを必須とする。
- 適用可能範囲:
  - `policy:allow-test-change`: テスト実行コマンド改変
  - `policy:allow-ci-change`: CI設定改変
- 適用不可範囲:
  - `skip/only` 記法追加
  - アサーション減少閾値違反
  - テストファイル削除
- 例外時でも理由・適用範囲・失効日・承認者の4項目を必須とする。

### FR-605 自動マージ

- 必須チェック合格 + ルール違反なし + 排他整合ありで自動マージ。
- 競合発生時は自動解消せず `blocked`。

## 5. 非機能要件

- 説明可能性: すべての `blocked` は機械判定根拠を残す。
- 誤検知管理: 例外適用の履歴が監査できる。

## 6. 入出力契約

### 入力

- PR 差分
- CI ステータス
- 例外ラベル情報

### 出力

- `pass` / `blocked`
- 検知詳細（ルールID、対象ファイル、理由）
- 例外適用時の監査項目（`exception_label`, `approver`, `expiry_date`, `scope`）

## 7. 異常系

- CI API 取得失敗: 判定停止（fail-safe）。
- ルールエンジン失敗: マージ禁止で `blocked`。
- 必須チェック一覧未設定: 自動マージ機能を無効化。

## 8. 受け入れ条件

- テスト削除や `skip/only` 混入が機械判定で検知される。
- 例外ラベルが付与されても、`skip/only` 追加とテスト削減閾値違反は自動で止まる。
- 必須チェック未通過 PR はマージされない。

## 9. 未決事項

- なし（v0.2範囲で確定済み）。
