# モデルルーティングとリソース制御仕様書 v0.2-draft

## 1. 目的

モデル名固定を排除し、運用で差し替え可能なルーティングと安全な並列制御を定義する。

## 2. スコープ

- Model Label -> Resolved Model 解決
- LiteLLM 経由の計測
- LM Studio JIT ロード/TTL アンロード
- 動的並列制御（段階制御）

## 3. 前提

- OpenHands は概念ラベルのみ指定する。
- 解決責任は LiteLLM Proxy が持つ。
- v0.2 の負荷シグナルは「LM Studio キュー詰まり + macOS メモリプレッシャ」。
- 想定ホストは Apple Mac Studio（M3 Ultra / メモリ512GB）。

## 4. 機能要件

### FR-401 ラベル解決

- タスクは実モデル名を直接指定しない。
- 必須ラベル: `reasoning` / `code` / `view` / `light`。
- LiteLLM は解決結果を Task Log に返す。

### FR-402 解決失敗時

- 解決不可ラベルは実行不可。
- フォールバックを使う場合は運用設定で明示し、ログに `fallback_used=true` を残す。

### FR-403 計測

- LiteLLM 側で以下を計測:
  - トークン数
  - レイテンシ
  - モデル解決結果

### FR-404 JIT/TTL

- 既定は JIT ロード。
- 一定時間未使用で TTL アンロード。
- 不具合検知（メモリ二重確保など）時は対象モデルを一時停止。

### FR-405 並列制御

- 同時 Run 上限は固定値ではなく段階制御で決定。
- 初期段階:
  - Level 0: 新規開始停止
  - Level 1: 新規開始を抑制（1件まで）
  - Level 2: 通常運転（2件まで）
- Level 遷移閾値（v0.2確定）:
  - Level 2 維持条件: `queue_depth <= 2` かつ `memory_pressure=normal`
  - Level 1 遷移条件: `queue_depth=3..5` または `memory_pressure=warning`
  - Level 0 遷移条件: `queue_depth >= 6` または `memory_pressure=critical`
- ヒステリシス（復帰条件）:
  - `Level 0 -> Level 1`: 15分連続で `memory_pressure != critical` かつ `queue_depth <= 4`
  - `Level 1 -> Level 2`: 30分連続で `memory_pressure=normal` かつ `queue_depth <= 2`
  - `Level 2 -> Level 1/0`: 条件成立で即時降格

### FR-406 制限値/並列レベルの見直し条件（運用）

- 適用対象:
  - v0.2 の標準環境（Apple Mac Studio M3 Ultra / 512GB）
  - DGX Spark は P2 の将来対応とし、本条件を流用せず別プロファイルで定義する
- 観測窓:
  - 日次サマリ（24時間）
  - 週次レビュー（7日移動）
- 下方調整トリガ（保守側へ倒す）:
  - `resource_exceeded` を理由とする blocked 率が 24時間で 5% 超
  - 平均 run 時間（stage別）が直近7日中央値比で 30% 以上悪化
  - メモリプレッシャ警告が 24時間で 3 回以上
- 上方調整トリガ（拡張を検討）:
  - `resource_exceeded` を理由とする blocked 率が 7日連続で 1% 未満
  - 平均 run 時間（stage別）が直近7日中央値比で悪化していない
  - メモリプレッシャ警告が 7日連続で 0 回
- 調整単位:
  - 1回の変更で「並列レベル」または「コンテナ制限値」のどちらか1つのみを変更
  - 連続変更は最低24時間空ける
- 指標の集計単位:
  - `resource_exceeded` blocked率は **Run単位** で算出する
  - 算式: `resource_exceeded が主要因の blocked Run 数 / (成功Run数 + blocked Run数)`

### FR-407 fallback利用条件（v0.2確定）

- fallbackは「同一ラベル系列内」でのみ許可する。
  - 例: `code -> code-light` は可、`reasoning -> code` は不可
- 1タスクあたり fallback 試行は最大1回。
- fallback 実行時は以下を必ずログに残す:
  - `fallback_used=true`
  - 元ラベル/解決失敗理由/代替モデル
- fallback 後も失敗した場合は `blocked` へ遷移し、自動で別系列へ再試行しない。
- fallback 監視ルール:
  - 24時間で `fallback_used=true` の比率が 10% を超えた場合、運用アラートを発火する。

## 5. 非機能要件

- 観測性: すべての呼び出しがラベルと実モデル名で追跡可能。
- 交換容易性: ラベルマップ更新でモデル差し替え可能。

## 6. 入出力契約

### 入力

- `model_label`
- 現在負荷指標（queue depth, memory pressure）

### 出力

- `resolved_model`
- 計測メトリクス
- 並列レベル判定結果

## 7. 異常系

- LM Studio 応答停止: 新規 Run 開始停止（Level 0）へ遷移。
- LiteLLM ルーティング障害: 全タスク中断、`blocked` 推奨。
- 負荷指標取得失敗: 保守側へ倒し Level 1 で運転継続。

## 8. 受け入れ条件

- Task Log で `label` と `resolved_model` が必ず確認できる。
- ルーティング定義変更後、タスク側設定変更なしでモデル切替できる。
- 負荷悪化時に同時 Run 上限が自動低下する。

## 9. 未決事項

- なし（v0.2範囲で確定済み）。
