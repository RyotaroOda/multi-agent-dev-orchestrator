# モデルルーティングとリソース制御仕様書 v0.2-draft

## 1. 目的

モデル名固定を排除し、運用で差し替え可能なルーティングと安全な並列制御を定義する。

## 2. スコープ

- Model Label -> Resolved Model 解決
- LiteLLM 経由の計測
- LM Studio JIT ロード/TTL アンロード
- 動的並列制御（段階制御）

## 3. 前提

- OpenHands は概念ラベルのみ指定する。
- 解決責任は LiteLLM Proxy が持つ。
- v0.2 の負荷シグナルは「LM Studio キュー詰まり + macOS メモリプレッシャ」。
- 想定ホストは Apple Mac Studio（M3 Ultra / メモリ512GB）。

## 4. 機能要件

### FR-401 ラベル解決

- タスクは実モデル名を直接指定しない。
- 必須ラベル: `reasoning` / `code` / `view` / `light`。
- LiteLLM は解決結果を Task Log に返す。

### FR-402 解決失敗時

- 解決不可ラベルは実行不可。
- フォールバックを使う場合は運用設定で明示し、ログに `fallback_used=true` を残す。

### FR-403 計測

- LiteLLM 側で以下を計測:
  - トークン数
  - レイテンシ
  - モデル解決結果

### FR-404 JIT/TTL

- 既定は JIT ロード。
- 一定時間未使用で TTL アンロード。
- 不具合検知（メモリ二重確保など）時は対象モデルを一時停止。

### FR-405 並列制御

- 同時 Run 上限は固定値ではなく段階制御で決定。
- 初期段階:
  - Level 0: 新規開始停止
  - Level 1: 新規開始を抑制（1件まで）
  - Level 2: 通常運転（2件まで）

## 5. 非機能要件

- 観測性: すべての呼び出しがラベルと実モデル名で追跡可能。
- 交換容易性: ラベルマップ更新でモデル差し替え可能。

## 6. 入出力契約

### 入力

- `model_label`
- 現在負荷指標（queue depth, memory pressure）

### 出力

- `resolved_model`
- 計測メトリクス
- 並列レベル判定結果

## 7. 異常系

- LM Studio 応答停止: 新規 Run 開始停止（Level 0）へ遷移。
- LiteLLM ルーティング障害: 全タスク中断、`blocked` 推奨。
- 負荷指標取得失敗: 保守側へ倒し Level 1 で運転継続。

## 8. 受け入れ条件

- Task Log で `label` と `resolved_model` が必ず確認できる。
- ルーティング定義変更後、タスク側設定変更なしでモデル切替できる。
- 負荷悪化時に同時 Run 上限が自動低下する。

## 9. 未決事項

- 各 Level への遷移閾値（queue depth, memory pressure）の具体値。
- Level 復帰条件（ヒステリシス）設計。
- `fallback_used` を許可する運用条件。
