# GitHub App認証と鍵管理仕様書 v0.2-draft

## 1. 目的

自動PR作成の認証主体を GitHub App に固定し、過剰権限と秘密鍵漏えいリスクを抑えた運用基準を定義する。

## 2. スコープ

- GitHub App の必要権限
- installation token 運用
- 秘密鍵の保管/ローテーション
- 失効時の復旧手順
- 監査ログ要件

## 3. 前提

- PR作成主体は GitHub App（bot）とする。
- 人アカウントの PAT は非常時の暫定手段としてのみ扱う。
- コンテナ内に GitHub 書き込み資格情報を配置しない。

## 4. 機能要件

### FR-1401 App権限の最小化

- Repository permissions は次を基準とする。
  - `Contents: Read and write`
  - `Pull requests: Read and write`
  - `Issues: Read and write`
  - `Metadata: Read-only`
- 上記以外の write 権限は付与しない。

### FR-1402 installation token 運用

- token は Run 実行ごとに都度発行する。
- token を永続保存しない（メモリ上のみ保持）。
- token 期限切れ時は再発行して1回のみ再試行する。

### FR-1403 秘密鍵保管ルール

- 秘密鍵はホストの安全ストア（OSキーチェーン/秘密管理基盤）に保管する。
- リポジトリ/Issue/ログへ秘密鍵本文を出力しない。
- 鍵アクセスは PR作成Runner の実行主体だけに限定する。

### FR-1404 鍵ローテーション

- ローテーション周期: 90日以内（推奨30日）。
- ローテーション実施時は次を記録する。
  - 実施日
  - 実施者
  - 対象 App
  - 旧鍵無効化確認
- 周期超過時はアラートを発火する。

### FR-1405 失効/漏えい時のインシデント手順

- 検知時は即時に旧鍵を無効化し、Run を `blocked` とする。
- 新鍵発行後、最小権限を再確認してから Run を再開する。
- 影響範囲（対象Run/PR/Issue）を `意思決定ログ` に記録する。

### FR-1406 監査要件

- 監査ログに次を含める。
  - `run_id`
  - `app_slug`
  - token 発行時刻/失効時刻
  - 失敗理由（発行失敗/権限不足/期限切れ）
- 自動PR本文には `run_id` と `app_slug` を含める。

## 5. 非機能要件

- 可用性: token 発行失敗時に1回再試行できること。
- 監査性: App利用の追跡情報を Run 単位で確認できること。
- 安全性: 鍵漏えい時の封じ込めを10分以内に開始できること。

## 6. 入出力契約

### 入力

- App ID
- Installation ID
- 秘密鍵参照（安全ストア）
- `run_id`

### 出力

- installation token（短命）
- PR作成結果
- 監査ログ

## 7. 異常系

- token発行失敗: 1回再試行後に `blocked`。
- 権限不足: `blocked` として App設定修正を要求。
- 鍵ローテーション遅延: アラート発火、以降のRunは `warning` 付きで継続。
- 漏えい疑い: 即時鍵失効、影響範囲調査、暫定的に手動運用へ切替。

## 8. 受け入れ条件

- 最小権限セットが文書化されている。
- 鍵保管/ローテーション/失効時対応手順が1文書で参照できる。
- `run_id` と `app_slug` で監査追跡が可能である。

## 9. 未決事項

- 安全ストア実装（OSキーチェーン or 外部シークレットマネージャ）の最終選定。
