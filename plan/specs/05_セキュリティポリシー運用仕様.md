# セキュリティポリシー運用仕様書 v0.2-draft

## 1. 目的

優先順位 A:漏えい防止 > B:ホスト保護 > C:課金回避 を運用で強制し、例外利用を監査可能にする。

## 2. スコープ

- LLM 送信ポリシー
- ネットワーク外向き制御
- ログ最小化ポリシー
- 例外ラベル運用

## 3. 前提

- 既定はローカル推論（LM Studio）。
- クラウド LLM は禁止モードを既定（`policy:cloud-llm=deny`）。
- 例外許可は運用フローを経た場合のみ有効。

## 4. 機能要件

### FR-501 外部送信制御

- コード全文、秘密情報、詳細ログは外部送信禁止。
- Web 検索経路ではクエリのみ送信可。
- 送信前に禁止データ混入チェックを実行。

### FR-502 ポリシーモード

- 既定: `policy:cloud-llm=deny`
- 例外: `policy:cloud-llm=allow`（期限付き）

### FR-503 例外ラベル必須項目

例外有効化には以下4項目を必須とする。

- 理由
- 適用範囲（Issue/Stage）
- 失効日（YYYY-MM-DD）
- 承認者

いずれか欠落時は deny 扱い。

### FR-506 例外承認と時刻基準（v0.2確定）

- 承認者:
  - `policy:cloud-llm=allow`: PM + セキュリティ担当の共同承認を必須
  - `policy:allow-test-change` / `policy:allow-ci-change`: PM承認を必須（24時間以内の事後追認あり）
- 失効日時の基準:
  - 失効日は `UTC 23:59:59` を基準として評価する
- 誤検知時エスカレーション:
  - 申請から4時間以内にセキュリティ担当へ一次エスカレーション
  - 判定保留時は fail-closed を維持し、`agent:blocked` で停止する

### FR-504 ネットワーク制御

- allowlist 外通信は遮断。
- 通信先変更は監査対象として記録。

### FR-505 ログ最小化

- 原則収集:
  - `run_id`, `stage`, `model_label`, `resolved_model`
  - トークン数、レイテンシ、主要コマンド pass/fail
- 原則非収集:
  - プロンプト本文、応答本文、コード全文、秘密情報

## 5. 非機能要件

- 監査性: 例外利用履歴を時系列で追跡可能。
- 抑止力: 期限切れ例外は自動無効化される。

## 6. 入出力契約

### 入力

- ラベルイベント
- 例外申請メタデータ（理由/適用範囲/失効日/承認者）

### 出力

- ポリシー評価結果（allow/deny）
- 拒否理由コード

## 7. 異常系

- 失効日判定不可: fail-closed で deny。
- 混入チェック機構異常: 外部送信を停止し `blocked`。
- 例外多発検知: 運用アラートを発火。

## 8. 受け入れ条件

- 期限未設定の例外ラベルが有効化されない。
- 送信禁止データ混入時に実行が停止する。
- 例外利用の監査ログが Issue 単位で追跡できる。

## 9. 未決事項

- なし（v0.2範囲で確定済み）。
