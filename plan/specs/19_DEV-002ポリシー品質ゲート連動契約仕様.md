# DEV-002 ポリシー品質ゲート連動契約仕様 v0.2-draft

## 1. 目的

Issue `#6`（DEV-002）で扱うポリシー判定と品質ゲート判定の連動条件を、`13`/`15`/`16`/`17` を起点に固定し、例外運用の解釈差分を抑止する。

## 2. スコープ

- 対象機能: `F-1305`（セキュリティポリシー評価）、`F-1306`（品質ゲートと自動マージ判定）
- 対象Issue: `#6`
- 対象判定: `allow/deny`、`pass/blocked`
- 対象外: 実装方式、CI基盤固有の詳細設定

## 3. 前提

- 現在フェーズは企画であり、実装コード作成・依存追加・ビルド/テスト実行は行わない。
- 例外ラベルは4項目（理由/適用範囲/失効日/承認者）を必須とする。
- `policy:allow-test-change` / `policy:allow-ci-change` は PM承認を必須とし、緊急適用時は24時間以内のセキュリティ担当事後追認を必須とする。
- 判定不能時は fail-closed を適用する。
- セキュリティ優先順位 `A:漏えい防止 > B:ホスト保護 > C:課金回避` を維持する。

## 4. 入力契約

| 入力ID | 入力名 | 必須項目 | 受理条件 | 不受理時 |
| --- | --- | --- | --- | --- |
| IN-1901 | 例外申請データ | `label`, `reason`, `scope`, `expiry_date`, `approver` | 4項目がすべて存在し、失効日が有効 | `deny` + `blocked_reason=policy_denied` |
| IN-1902 | 品質判定入力 | `ci_statuses`, `diff_summary`, `required_checks` | 必須チェック定義が揃っている | `blocked` + `blocked_reason=quality_rule_violation` |
| IN-1903 | 例外適用付き品質判定入力 | `exception_metadata`, `violation_type` | 例外ラベルが有効かつ適用範囲が一致 | `blocked` + `blocked_reason=policy_denied` |

## 5. 判定連動契約

| 順序 | 判定ステップ | 条件 | 出力 |
| --- | --- | --- | --- |
| 1 | ポリシー事前判定 | 例外4項目の充足確認 | `allow` または `deny` |
| 2 | 品質ゲート判定 | 必須チェックと差分ルール評価 | `pass` または `blocked` |
| 3 | 連動判定確定 | `allow + pass` のみ次処理へ進む | 実行継続 or `blocked` |

補足:
- `deny` が先に確定した場合、品質ゲートは参考評価として扱い、最終出力は `blocked` に固定する。
- 失効日判定不能・承認者不正は、差分内容に関係なく `deny` に固定する。
- 例外適用時は品質ゲート出力へ `exception_label`, `approver`, `expiry_date`, `scope` を必須付与する。

## 6. 差分違反と例外適用契約

| 違反種別 | 既定動作 | 例外適用条件 | 監査必須記録 |
| --- | --- | --- | --- |
| `skip/only` 記法追加 | `blocked` | 例外適用不可 | `violation_type`, `approver`, `expiry_date` |
| テスト削除・大幅減少 | `blocked` | 例外適用不可 | `affected_files`, `assertion_delta` |
| CI設定改変 | `blocked` | `policy:allow-ci-change` が有効 | `workflow_files`, `approver` |
| テスト実行コマンド改変 | `blocked` | `policy:allow-test-change` が有効 | `command_diff`, `approver` |
| 必須チェック未設定 | fail-safeで停止 | 例外適用不可 | `required_checks_snapshot` |

## 7. `blocked_reason` 最小分類（DEV-002）

| 分類 | 説明 | 優先度 |
| --- | --- | --- |
| `policy_denied` | 例外要件不備またはポリシー拒否 | P0 |
| `quality_rule_violation` | 差分ルール違反または必須チェック未達 | P0 |
| `rule_engine_error` | 判定エンジン異常でfail-closed | P0 |
| `exception_expired` | 例外ラベル期限切れ | P1 |

補足:
- 主要因は1つに固定し、補助要因は `secondary_reasons` へ記録する。

## 8. 受け入れ観点（企画）

- 例外4項目不足時に必ず `deny/blocked` へ遷移する。
- ポリシー判定と品質判定の優先順が一意に読める。
- 例外適用時の監査項目（承認者・失効日・適用範囲）が欠落しない。
- `17_初回開発着手ハンドオーバー仕様.md` の DEV-002 条件と矛盾しない。

## 9. 未決事項

- なし（v0.2の初回着手範囲で確定済み）。
