# 機能別開発者実装準備仕様書 v0.2-draft

## 1. 目的

既存の個別仕様（01〜12）を機能単位で横断整理し、開発者が実装前に参照すべき入力/処理/出力/受け入れ条件を一枚で確認できる状態にする。

## 2. 前提

- 現在フェーズは企画であり、実装コード作成・依存追加・ビルド/テスト実行は行わない。
- 標準実行環境は Apple Mac Studio M3 Ultra（メモリ512GB）とする。
- NVIDIA DGX Spark は将来対応（P2）とし、v0.2必須スコープには含めない。
- 判定体制は `AIプランナーエージェント（評価支援） + ユーザー（最終判定）` とする。
- セキュリティ優先順位 `A:漏えい防止 > B:ホスト保護 > C:課金回避` を崩さない。

## 3. 機能マップ（開発者向け）

| 機能ID | 機能名 | 主仕様 | 関連仕様 |
| --- | --- | --- | --- |
| F-1301 | Issue受付と実行状態管理 | `01_Issue駆動実行管理仕様.md` | `plan/templates/Issueテンプレート_v0.2.md` |
| F-1302 | 隔離実行基盤 | `02_隔離実行基盤仕様.md` | `10_セキュリティ境界マトリクス.md` |
| F-1303 | タスク分解とロール実行 | `03_タスク分解とロール実行仕様.md` | `01_Issue駆動実行管理仕様.md` |
| F-1304 | モデルルーティング/リソース制御 | `04_モデルルーティングとリソース制御仕様.md` | `08_可観測性とKPI運用仕様.md` |
| F-1305 | セキュリティポリシー評価 | `05_セキュリティポリシー運用仕様.md` | `10_セキュリティ境界マトリクス.md`, `11_policy例外ラベル運用規程.md` |
| F-1306 | 品質ゲートと自動マージ判定 | `06_品質ゲートと自動マージ仕様.md` | `11_policy例外ラベル運用規程.md` |
| F-1307 | 成果物受け渡しとPR作成 | `07_成果物受け渡しとPR作成仕様.md` | `01_Issue駆動実行管理仕様.md` |
| F-1308 | 可観測性とKPI運用 | `08_可観測性とKPI運用仕様.md` | `04_モデルルーティングとリソース制御仕様.md` |
| F-1309 | M4判定と開発着手条件 | `12_M4本判定と開発着手条件仕様.md` | `plan/M4_Go-No-Goチェックリスト.md`, `plan/意思決定ログ.md` |
| F-1310 | DGX Spark将来対応 | `09_DGX Spark対応方針.md` | `04_モデルルーティングとリソース制御仕様.md`, `08_可観測性とKPI運用仕様.md` |

## 4. 機能別仕様（実装前確認項目）

### F-1301 Issue受付と実行状態管理

- 入力:
  - Issue本文（Spec Block）
  - 実行トリガ（コメント/ラベル）
- 処理要件:
  - Spec Block妥当性を検証し、不足時は `blocked` とする。
  - `queued/running/blocked/completed` の状態遷移を一意に管理する。
  - `blocked_reason` を必須記録し、復帰時は新しい `run_id` を発行する。
- 出力:
  - 実行状態
  - `run_id` と監査用メタデータ
- 受け入れ条件:
  - 無効Issueが実行されない。
  - 状態遷移と復帰履歴が追跡可能である。

### F-1302 隔離実行基盤

- 入力:
  - `run_id`
  - 実行対象タスク
- 処理要件:
  - 1 Issue / 1 Run / 1隔離コンテナを満たす。
  - CPU/メモリ/PIDs/ディスク上限を強制する。
  - ホスト書き込み禁止とネットワーク制約を既定で適用する。
- 出力:
  - 実行ログ（最小項目）
  - 失敗時の終了理由
- 受け入れ条件:
  - 隔離破りを検知した場合は fail-closed で停止する。

### F-1303 タスク分解とロール実行

- 入力:
  - Issueの目的/受け入れ条件
- 処理要件:
  - ルールベースDAGでタスクを分解する。
  - `ops` ステージは例外条件を満たしたときのみ許可する。
  - 共有コンテキストは最小セットに制限する。
- 出力:
  - ロール別の実行計画
  - ステージ別の進行結果
- 受け入れ条件:
  - 同一入力で分解結果の再現性が保たれる。

### F-1304 モデルルーティング/リソース制御

- 入力:
  - タスク種別
  - 現在の負荷指標
- 処理要件:
  - ローカル推論を既定とし、fallbackは同一系列1回までに制限する。
  - 並列度は段階制御（0/1/2）と閾値に基づいて遷移する。
  - `fallback_used` を監査項目として必ず記録する。
- 出力:
  - 解決済みモデルラベル
  - 制御レベルと遷移理由
- 受け入れ条件:
  - 閾値超過時に過負荷継続を防止できる。

### F-1305 セキュリティポリシー評価

- 入力:
  - 実行イベント
  - 例外ラベル申請データ
- 処理要件:
  - 例外は `理由/適用範囲/失効日/承認者` の4項目が揃った場合のみ有効。
  - 外部送信禁止データ混入時は即時 `deny` とする。
  - 判定不能時は fail-closed を適用する。
- 出力:
  - `allow/deny`
  - 拒否理由コード
- 受け入れ条件:
  - セキュリティ優先順位Aに反する実行が通らない。

### F-1306 品質ゲートと自動マージ判定

- 入力:
  - CI結果
  - 変更差分情報
- 処理要件:
  - 必須チェック未達時は自動で `blocked` とする。
  - `skip` 記法追加やテスト削減を閾値で検知する。
  - 例外ラベルの有効性を事前検証してから例外判定する。
- 出力:
  - `pass/blocked`
  - ブロック理由
- 受け入れ条件:
  - CI回避による品質低下が未検知で通過しない。

### F-1307 成果物受け渡しとPR作成

- 入力:
  - コンテナ出力（差分/結果）
  - `run_id`
- 処理要件:
  - 方式A（コンテナ非push）を維持する。
  - `run_id` 紐付けと `SHA-256` 検証を必須化する。
  - PR作成主体は GitHub App（bot）に固定し、人アカウントのPAT常用を避ける。
  - retry時は旧PR close + 新PR相互参照を記録する。
- 出力:
  - 検証済み差分
  - PR情報
- 受け入れ条件:
  - 改ざん/取り違えを検知できる。

### F-1308 可観測性とKPI運用

- 入力:
  - 実行ログ
  - 品質ゲート結果
- 処理要件:
  - KPI（throughput/merge率/blocked率/run時間等）を集計する。
  - 保持期間と保存先ルールを適用する。
  - 閾値逸脱時はアラートと見直しトリガを発火する。
- 出力:
  - KPIダッシュボード用集計
  - アラート記録
- 受け入れ条件:
  - M4判定に必要な指標が再現可能に取得できる。

### F-1309 M4判定と開発着手条件

- 入力:
  - `plan/M4_Go-No-Goチェックリスト.md`
  - `plan/バックログ.md`
  - `plan/リスク登録簿.md`
  - `plan/意思決定ログ.md`
- 処理要件:
  - 判定手順は `AIプランナーエージェント -> ユーザー最終判定` で固定する。
  - 凍結対象文書への通常更新停止時刻を遵守する。
  - Go時の初回着手Issueは DoR を全充足したものに限定する。
- 出力:
  - Go/Conditional Go/No-Go
  - 不足項目と次アクション
- 受け入れ条件:
  - 判定根拠と判定結果の追跡可能性が担保される。

### F-1310 DGX Spark将来対応（P2）

- 入力:
  - Mac基準の制限値/KPI
  - DGX差分要件
- 処理要件:
  - DGX対応はP2バックログとして分離管理する。
  - 移行判定は専用Go/No-Go条件で評価する。
  - v0.2必須スコープへの混入を防ぐ。
- 出力:
  - DGX移行判断材料
  - 差分制限値案
- 受け入れ条件:
  - v0.2収束を遅らせずに将来移行準備を継続できる。

## 5. 実装前ゲート（共通）

- 参照順は本仕様書 -> 各個別仕様（01〜12）とする。
- 競合要件がある場合は `plan/意思決定ログ.md` の accepted ADR を優先する。
- 例外運用は常に `plan/specs/11_policy例外ラベル運用規程.md` を正本とする。

## 6. 未決事項

- なし（v0.2範囲で確定済み）。
